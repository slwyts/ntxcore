<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexTradeDAO 管理后台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.10.7/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #50E3C2;
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333;
            --light-text-color: #666;
            --border-color: #e0e0e0;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            overflow-y: scroll;
        }

        /* Login page style */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100vh;
            background-color: var(--primary-color);
        }

        .login-container {
            background-color: var(--card-background);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-container h2 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 2em;
        }

        .login-form .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--light-text-color);
        }

        .login-form input[type="email"],
        .login-form input[type="password"] {
            width: calc(100% - 20px);
            padding: 12px 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1em;
        }

        .login-form button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .login-form button:hover {
            background-color: #3a7bd5;
        }

        /* Main dashboard layout */
        #main-dashboard {
            display: none;
            flex: 1;
            display: flex;
        }

        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar .logo {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8em;
            font-weight: bold;
            color: var(--secondary-color);
            padding: 0 20px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .sidebar ul li {
            margin-bottom: 5px;
        }

        .sidebar ul li a {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
        }

        .sidebar ul li a i {
            margin-right: 10px;
            font-size: 1.1em;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: #34495e;
            border-left: 5px solid var(--primary-color);
            padding-left: 15px;
        }

        .logout-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            text-align: center;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        .content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            margin: 0;
            color: var(--primary-color);
        }

        .welcome-message {
            font-size: 1.1em;
            color: var(--light-text-color);
        }

        .section {
            background-color: var(--card-background);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .section h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        /* Table style */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            border: 1px solid var(--border-color);
            padding: 12px 15px;
            text-align: left;
        }

        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: var(--text-color);
        }

        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .data-table tr:hover {
            background-color: #f1f1f1;
        }

        /* Form style */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--light-text-color);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="date"], /* Added for date input */
        .form-group textarea,
        .form-group select {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
        }

        .form-actions {
            margin-top: 25px;
            text-align: right;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-left: 10px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #3a7bd5;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-secondary {
            background-color: #bdc3c7;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #95a5a6;
        }

        /* Search and filter */
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .filter-controls input, .filter-controls select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        /* Card layout */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-background);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: var(--light-text-color);
            font-size: 1.1em;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .card .value {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .card .description {
            font-size: 0.9em;
            color: #888;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background-color: #3a7bd5;
        }

        .pagination button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Specific content area display */
        .content-area {
            display: none;
        }
        .content-area.active {
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-background);
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
                padding: 10px 0;
            }
            .sidebar .logo {
                font-size: 1.2em;
                margin-bottom: 20px;
            }
            .sidebar ul li a {
                padding: 15px 10px;
                justify-content: center;
            }
            .sidebar ul li a span {
                display: none;
            }
            .sidebar ul li a i {
                margin-right: 0;
            }
            .logout-btn {
                margin: 10px;
                padding: 10px;
            }
            .content {
                padding: 20px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .card-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="login-container">
            <h2>NexTradeDAO 管理后台</h2>
            <form id="login-form" class="login-form">
                <div class="input-group">
                    <label for="email">邮箱:</label>
                    <input type="email" id="email" name="email" required autocomplete="username">
                </div>
                <div class="input-group">
                    <label for="password">密码:</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <button type="submit">登录</button>
            </form>
        </div>
    </div>

    <div id="main-dashboard">
        <aside class="sidebar">
            <div class="logo">NexTradeDAO Admin</div>
            <nav>
                <ul>
                    <li><a href="#" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> <span>仪表盘</span></a></li>
                    <li><a href="#" data-section="user-management"><i class="fas fa-users"></i> <span>用户管理</span></a></li>
                    <li><a href="#" data-section="exchange-management"><i class="fas fa-exchange-alt"></i> <span>交易所管理</span></a></li>
                    <li><a href="#" data-section="user-exchange-bindings"><i class="fas fa-link"></i> <span>用户绑定查询</span></a></li>
                    <li><a href="#" data-section="kol-management"><i class="fas fa-star"></i> <span>KOL管理</span></a></li>
                    <li><a href="#" data-section="trade-data"><i class="fas fa-chart-line"></i> <span>交易数据</span></a></li>
                    <li><a href="#" data-section="article-management"><i class="fas fa-newspaper"></i> <span>文章管理</span></a></li>
                    <li><a href="#" data-section="commission-referral"><i class="fas fa-handshake"></i> <span>佣金与推荐</span></a></li>
                    <li><a href="#" data-section="course-payment-management"><i class="fas fa-chalkboard-teacher"></i> <span>课程与支付</span></a></li>
                    <li><a href="#" data-section="withdrawal-orders"><i class="fas fa-money-check-alt"></i> <span>提现订单</span></a></li>
                    <li><a href="#" data-section="dao-auction"><i class="fas fa-gavel"></i> <span>DAO 拍卖</span></a></li>
                    <li><a href="#" data-section="system-tools"><i class="fas fa-cogs"></i> <span>系统工具</span></a></li>
                    
                </ul>
            </nav>
            <button class="logout-btn" id="logout-button"><i class="fas fa-sign-out-alt"></i> 退出登录</button>
        </aside>

        <main class="content">
            <header class="header">
                <h1 id="current-page-title">仪表盘</h1>
                <div class="welcome-message">欢迎, <span id="admin-nickname">管理员</span>!</div>
            </header>

            <section id="dashboard" class="content-area active">
                <div class="section">
                    <h2>平台总览</h2>
                    <div class="card-grid" id="dashboard-summary">
                        <!-- New cards for the provided backend data -->
                        <div class="card">
                            <h3>待处理提现</h3>
                            <p class="value" id="pending-withdrawals">...</p>
                            <p class="description">待管理员审核提现请求</p>
                        </div>
                        <div class="card">
                            <h3>今日新增用户</h3>
                            <p class="value" id="new-users-today">...</p>
                            <p class="description">今日注册的新用户数</p>
                        </div>
                        <div class="card">
                            <h3>总 NTX 挖矿产出</h3>
                            <p class="value" id="total-ntx-mined">...</p>
                            <p class="description">平台累计挖矿产出</p>
                        </div>
                        <div class="card">
                            <h3>总 USDT 手续费</h3>
                            <p class="value" id="total-usdt-fees">...</p>
                            <p class="description">平台累计手续费</p>
                        </div>
                        <div class="card">
                            <h3>总 NTX 销毁量</h3>
                            <p class="value" id="total-burned">...</p>
                            <p class="description">平台累计NTX销毁总量</p>
                        </div>
                        <div class="card">
                            <h3>总交易量 (USDT)</h3>
                            <p class="value" id="total-trading-volume-dashboard">...</p> <!-- Changed ID to avoid conflict -->
                            <p class="description">平台累计交易量</p>
                        </div>
                        <div class="card">
                            <h3>平台总用户数</h3>
                            <p class="value" id="platform-users">...</p> <!-- New ID for platformUsers -->
                            <p class="description">平台注册用户总数</p>
                        </div>
                        <!-- Original cards that might not be used or need remapping -->
                        <!--
                        <div class="card">
                            <h3>总用户数 (Original)</h3>
                            <p class="value" id="total-users">...</p>
                            <p class="description">注册用户总数</p>
                        </div>
                        <div class="card">
                            <h3>今日活跃用户 (Original)</h3>
                            <p class="value" id="today-active-users">...</p>
                            <p class="description">当日活跃挖矿用户</p>
                         </div>
                         <div class="card">
                            <h3>今日 NTX 销毁量 (Original)</h3>
                            <p class="value" id="today-ntx-burned">...</p>
                            <p class="description">当日NTX销毁总量</p>
                        </div>
                        <div class="card">
                            <h3>今日 USDT 返佣 (Original)</h3>
                            <p class="value" id="today-usdt-rebate">...</p>
                            <p class="description">当日用户总USDT返佣</p>
                        </div>
                        -->
                    </div>
                </div>
            </section>

            <section id="user-management" class="content-area">
                <div class="section">
                    <h2>用户管理</h2>
                    <div class="filter-controls">
                        <input type="text" id="user-search-input" placeholder="搜索用户 (ID/邮箱/昵称)">
                        <button class="btn btn-primary" id="search-users-btn">搜索</button>
                        <button class="btn btn-success" id="create-user-btn">创建新用户</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>昵称</th>
                                <th>邮箱</th>
                                <th>邀请码</th>
                                <th>邀请人</th>
                                <th>USDT余额</th>
                                <th>NTX余额</th>
                                <!-- <th>身份</th> -->
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="user-list-body">
                            </tbody>
                    </table>
                    <div class="pagination">
                        <button id="prev-user-page" disabled>上一页</button>
                        <span id="current-user-page-info">第 1 页 / 共 1 页</span>
                        <button id="next-user-page">下一页</button>
                    </div>
                </div>
            </section>

            <section id="exchange-management" class="content-area">
                <div class="section">
                    <h2>交易所管理</h2>
                    <button class="btn btn-success" id="create-exchange-btn">添加新交易所</button>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>名称</th>
                                <th>Logo URL</th>
                                <th>挖矿效率</th>
                                <th>CEX URL</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="exchange-list-body">
                            </tbody>
                    </table>
                </div>
            </section>
            <section id="user-exchange-bindings" class="content-area">
                <div class="section">
                    <h2>用户交易所绑定查询</h2>
                    <div class="filter-controls">
                        <label for="binding-exchange-filter">选择交易所:</label>
                        <select id="binding-exchange-filter">
                            <option value="">-- 请选择 --</option>
                        </select>
                        <button class="btn btn-primary" id="search-bindings-btn">查询</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>用户 ID</th>
                                <th>用户邮箱</th>
                                <th>交易所 UID</th>
                            </tr>
                        </thead>
                        <tbody id="binding-list-body">
                            <tr>
                                <td colspan="3" style="text-align:center;">请先选择一个交易所并点击查询。</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            <!-- New Section: Trade Data -->
            <section id="trade-data" class="content-area">
                <div class="section">
                    <h2>手动添加交易数据</h2>
                    <form id="add-trade-data-form">
                        <div class="form-group">
                            <label for="trade-user-select">选择用户:</label>
                            <select id="trade-user-select" required>
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="trade-exchange-select">选择交易所:</label>
                            <select id="trade-exchange-select" required>
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="trade-volume">交易量 (USDT):</label>
                            <input type="number" step="0.01" id="trade-volume" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="trade-fee">交易手续费 (USDT):</label>
                            <input type="number" step="0.01" id="trade-fee" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="trade-date">交易日期:</label>
                            <input type="date" id="trade-date" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">添加交易数据</button>
                        </div>
                    </form>
                </div>
                <!-- <div class="section">
                    <h2>每日交易记录</h2>
                    <div class="filter-controls">
                        <label for="daily-trade-date-filter">选择日期:</label>
                        <input type="date" id="daily-trade-date-filter">
                        <button class="btn btn-primary" id="filter-daily-trades-btn">筛选</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>用户 ID</th>
                                <th>用户邮箱</th>
                                <th>交易所 ID</th>
                                <th>交易所名称</th>
                                <th>交易量 (USDT)</th>
                                <th>手续费 (USDT)</th>
                                <th>交易日期</th>
                            </tr>
                        </thead>
                        <tbody id="daily-trade-list-body">



                            
                        </tbody>
                    </table>
                </div> -->
            </section>

            <section id="article-management" class="content-area">
                <div class="section">
                    <h2>文章管理</h2>
                    <button class="btn btn-success" id="publish-article-btn">发布新文章</button>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>标题</th>
                                <th>摘要</th>
                                <th>图片</th>
                                <th>显示状态</th>
                                <th>发布日期</th>
                                <th>修改日期</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="article-list-body">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="commission-referral" class="content-area">
                <div class="section">
                    <h2>推荐关系</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>邀请人 ID</th>
                                <th>邀请人 邮箱</th>
                                <th>被邀请人 ID</th>
                                <th>被邀请人 昵称</th>
                                <th>被邀请人 邮箱</th>
                                <th>邀请日期</th>
                            </tr>
                        </thead>
                        <tbody id="referral-list-body">
                            </tbody>
                    </table>
                    <div class="pagination">
                        <button id="prev-referral-page" disabled>上一页</button>
                        <span id="current-referral-page-info">第 1 页 / 共 1 页</span>
                        <button id="next-referral-page">下一页</button>
                    </div>
                </div>

                <div class="section">
                    <h2>所有佣金记录</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>被邀请人昵称</th>
                                <th>类型</th>
                                <th>金额</th>
                                <th>日期</th>
                            </tr>
                        </thead>
                        <tbody id="commission-list-body">
                            </tbody>
                    </table>
                     <div class="pagination">
                        <button id="prev-commission-page" disabled>上一页</button>
                        <span id="current-commission-page-info">第 1 页 / 共 1 页</span>
                        <button id="next-commission-page">下一页</button>
                    </div>
                </div>

                <div class="section">
                    <h2>按邀请人汇总佣金</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>邀请人Email</th>
                                <th>总 USDT 返佣</th>
                            </tr>
                        </thead>
                        <tbody id="commission-summary-body">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="withdrawal-orders" class="content-area">
                <div class="section">
                    <h2>提现订单管理</h2>
                    <div class="filter-controls">
                        <select id="withdrawal-status-filter">
                            <option value="">所有状态</option>
                            <option value="pending">待处理</option>
                            <option value="approved">已批准</option>
                            <option value="rejected">已拒绝</option>
                            <option value="completed">已完成</option>
                        </select>
                        <button class="btn btn-primary" id="filter-withdrawal-btn">筛选</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>用户 ID</th>
                                <th>用户邮箱</th>
                                <th>金额 (USDT)</th>
                                <th>币种</th>
                                <th>提现地址</th>
                                <th>申请时间</th>
                                <th>处理时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawal-list-body">
                            </tbody>
                    </table>
                    <div class="pagination">
                        <button id="prev-withdrawal-page" disabled>上一页</button>
                        <span id="current-withdrawal-page-info">第 1 页 / 共 1 页</span>
                        <button id="next-withdrawal-page">下一页</button>
                    </div>
                </div>
            </section>

            <section id="dao-auction" class="content-area">
                <div class="section">
                    <h2>DAO 拍卖管理</h2>
                    <div class="filter-controls">
                         <button class="btn btn-success" id="start-auction-btn">开始新拍卖</button>
                         <button class="btn btn-danger" id="end-auction-btn">结束当前拍卖</button>
                    </div>

                    <h3>所有拍卖历史</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>拍卖轮次</th>
                                <th>收款地址</th>
                                <th>开始时间</th>
                                <th>结束时间</th>
                                <th>总投票数</th>
                                <th>总 NTX 参与</th>
                                <th>赢家 ID</th>
                                <th>赢家 NTX</th>
                                <th>赢家 ETH 地址</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody id="dao-auction-list-body">
                            </tbody>
                    </table>
                    <div class="pagination">
                        <button id="prev-auction-page" disabled>上一页</button>
                        <span id="current-auction-page-info">第 1 页 / 共 1 页</span>
                        <button id="next-auction-page">下一页</button>
                    </div>
                </div>
            </section>

            <!-- ==================================================================== -->
            <!-- KOL Management Section -->
            <!-- ==================================================================== -->
            <section id="kol-management" class="content-area">
                <div class="section">
                    <h2>KOL管理</h2>
                    <p>KOL可以获得额外手续费返佣加成</p>
                    <button class="btn btn-success" id="create-kol-btn">添加新KOL</button>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>用户ID</th>
                                <th>昵称</th>
                                <th>邮箱</th>
                                <th>返佣比例</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="kol-list-body">
                            <!-- KOL数据将通过JS动态加载 -->
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="system-tools" class="content-area">
                <div class="section">
                    <h2>系统工具</h2>
                    <div class="form-group">
                        <label for="settlement-date">选择结算日期 (YYYY-MM-DD):</label>
                        <input type="text" id="settlement-date" placeholder="例如: 2025-01-01">
                    </div>
                    <button class="btn btn-warning" id="trigger-settlement-btn">触发每日结算</button>
                     <p>触发每日结算会计算前一天的挖矿产出和佣金。</p>
                </div>
                <div class="section">
                        <h3>更新 NTX 分配控制百分比</h3>
                        <div class="form-group">
                            <label for="ntx-control-percentage">目标百分比 (0.0 - 99.99):</label>
                            <input type="number" id="ntx-control-percentage" class="form-control" step="0.01" min="0" max="99.99" value="0.0">
                        </div>
                        <button class="btn btn-primary" id="update-ntx-percentage-btn">更新百分比</button>
                    </div>

                    <div class="section">
                        <h3>强制 NTX 比例控制（给管理员自动刷交易数据）</h3>
                        <div class="form-group">
                            <label for="fntx-settlement-date">调整日期:</label>
                            <input type="date" id="fntx-settlement-date" class="form-control">
                        </div>
                        <button class="btn btn-warning" id="force-ntx-control-btn">执行强制调整</button>
                    </div>
            </section>

            <section id="course-payment-management" class="content-area">
                <div class="section">
                    <h2>订单管理</h2>
                    <div class="filter-controls">
                        <select id="course-order-status-filter">
                            <option value="">所有状态</option>
                            <option value="pending">待处理 (pending)</option>
                            <option value="confirmed">已确认 (confirmed)</option>
                            <option value="closed">已关闭 (closed)</option>
                        </select>
                        <button class="btn btn-primary" id="filter-course-orders-btn">筛选订单</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>订单ID</th>
                                <th>用户ID</th>
                                <th>套餐ID</th>
                                <th>原始金额</th>
                                <th>支付金额</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="course-orders-list-body"></tbody>
                    </table>
                </div>

                <div class="section">
                    <h2>权限组管理</h2>
                    <button class="btn btn-success" id="create-permission-group-btn">创建新权限组</button>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>名称</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="permission-group-list-body"></tbody>
                    </table>
                </div>

                <div class="section">
                    <h2>课程套餐管理</h2>
                    <button class="btn btn-success" id="create-course-package-btn">创建新套餐</button>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>所属权限组ID</th>
                                <th>有效天数</th>
                                <th>价格</th>
                                <th>货币</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="course-package-list-body"></tbody>
                    </table>
                </div>

                <div class="section">
                    <h2>课程管理</h2>
                    <button class="btn btn-success" id="create-course-btn">创建新课程</button>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>类型</th>
                                <th>名称</th>
                                <th>描述</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="course-list-body"></tbody>
                    </table>
                </div>
            </section>

            <div id="user-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button" data-modal="user-modal">&times;</span>
                    <h2>用户详情 / 编辑</h2>
                    <form id="user-detail-form">
                        <input type="hidden" id="user-id">
                        <!-- Add a hidden input to store myInviteCode -->
                        <input type="hidden" id="user-my-invite-code"> 
                        <div class="form-group">
                            <label>邮箱:</label>
                            <input type="email" id="user-email" disabled>
                        </div>
                        <div class="form-group">
                            <label for="user-nickname">昵称:</label>
                            <input type="text" id="user-nickname">
                        </div>
                        <div class="form-group">
                            <label for="user-password">密码:</label>
                            <input type="password" id="user-password">
                        </div>
                        <div class="form-group">
                            <label for="user-usdt-balance">USDT余额:</label>
                            <input type="number" step="0.01" id="user-usdt-balance">
                        </div>
                        <div class="form-group">
                            <label for="user-ntx-balance">NTX余额:</label>
                            <input type="number" step="0.0001" id="user-ntx-balance">
                        </div>
                        <div class="form-group">
                            <label for="user-level">经验值 (EXP):</label>
                            <input type="number" step="1" id="user-exp">
                        </div>
                        <div class="form-group">
                            <label for="user-is-admin">管理员:</label>
                            <input type="checkbox" id="user-is-admin">
                        </div>
                        <div class="form-group">
                            <label for="user-is-active">账户状态 (激活/封禁):</label>
                            <input type="checkbox" id="user-is-active">
                        </div>
                        <div class="form-group">
                            <label for="user-is-broker">强制为经纪商（无论是否满足条件）:</label>
                            <input type="checkbox" id="user-is-broker">
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="update-user-profile-btn">更新用户资料</button>
                            <!-- <button type="button" class="btn btn-danger" id="delete-user-btn">删除用户</button> -->
                        </div>
                    </form>
                </div>
            </div>

            <div id="create-user-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button" data-modal="create-user-modal">&times;</span>
                    <h2>创建新用户</h2>
                    <form id="create-user-form">
                        <div class="form-group">
                            <label for="new-user-email">邮箱:</label>
                            <input type="email" id="new-user-email" required>
                        </div>
                        <div class="form-group">
                            <label for="new-user-nickname">昵称:</label>
                            <input type="text" id="new-user-nickname" required>
                        </div>
                        <div class="form-group">
                            <label for="new-user-password">密码:</label>
                            <input type="password" id="new-user-password" required>
                        </div>
                        <div class="form-group">
                            <label for="new-user-invite-code">邀请码 (可选):</label>
                            <input type="text" id="new-user-invite-code">
                        </div>
                        <div class="form-group">
                            <label for="new-user-is-admin">设为管理员:</label>
                            <input type="checkbox" id="new-user-is-admin">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">创建用户</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="exchange-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button" data-modal="exchange-modal">&times;</span>
                    <h2 id="exchange-modal-title">添加新交易所</h2>
                    <form id="exchange-form">
                        <input type="hidden" id="exchange-id">
                        <div class="form-group">
                            <label for="exchange-name">交易所名称:</label>
                            <input type="text" id="exchange-name" required>
                        </div>
                        <div class="form-group">
                            <label for="exchange-logo-url">Logo URL:</label>
                            <input type="text" id="exchange-logo-url" required>
                        </div>
                        <div class="form-group">
                            <label for="exchange-mining-efficiency">挖矿效率:</label>
                            <input type="number" step="0.01" id="exchange-mining-efficiency" value="1.0" required>
                        </div>
                        <div class="form-group">
                            <label for="exchange-cex-url">CEX URL:</label>
                            <input type="text" id="exchange-cex-url" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="save-exchange-btn">保存</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="article-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button" data-modal="article-modal">&times;</span>
                    <h2 id="article-modal-title">发布新文章</h2>
                    <form id="article-form">
                        <input type="hidden" id="article-id">
                        <div class="form-group">
                            <label for="article-title">标题:</label>
                            <input type="text" id="article-title" required>
                        </div>
                         <div class="form-group">
                            <label for="article-summary">摘要:</label>
                            <input type="text" id="article-summary" required>
                        </div>
                         <div class="form-group">
                            <label for="article-image-url">图片 URL (可选):</label>
                            <input type="text" id="article-image-url">
                        </div>
                        <div class="form-group">
                            <label for="article-content">内容 (Markdown):</label>
                            <textarea id="article-content" rows="10" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="article-is-displayed">是否显示:</label>
                            <input type="checkbox" id="article-is-displayed" checked>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="save-article-btn">保存</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="dao-auction-start-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button" data-modal="dao-auction-start-modal">&times;</span>
                    <h2>开始新 DAO 拍卖</h2>
                    <form id="start-dao-auction-form">
                        <div class="form-group">
                            <label for="admin-bsc-address">管理员 BSC 收款地址:</label>
                            <input type="text" id="admin-bsc-address" required placeholder="0x...">
                        </div>
                        <div class="form-group">
                            <label for="auction-start-time">开始时间 (ISO 8601 格式):</label>
                            <input type="datetime-local" id="auction-start-time" required>
                        </div>
                        <div class="form-group">
                            <label for="auction-duration-minutes">持续时间 (分钟):</label>
                            <input type="number" id="auction-duration-minutes" required value="1440">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">发起拍卖</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ==================================================================== -->
            <!-- KOL Add/Edit Modal -->
            <!-- ==================================================================== -->
            <div id="kol-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button" data-modal="kol-modal">&times;</span>
                    <h2 id="kol-modal-title">添加新KOL</h2>
                    <form id="kol-form">
                        <!-- 在编辑模式下，这个字段将不可用 -->
                        <div class="form-group">
                            <label for="kol-user-id">用户ID:</label>
                            <input type="number" id="kol-user-id" class="form-control" required>
                            <small>输入一个已存在的用户ID，将其设置为KOL。</small>
                        </div>
                        <div class="form-group">
                            <label for="kol-commission-rate">返佣比例 (%):</label>
                            <input type="number" id="kol-commission-rate" class="form-control" step="0.1" min="0" max="100" required>
                            <small>例如：输入85.5代表85.5%的返佣。</small>
                        </div>
                        <div class="form-group">
                            <label for="kol-is-active">激活状态:</label>
                            <input type="checkbox" id="kol-is-active" checked>
                            <small>取消勾选可暂时禁用此KOL的特殊返佣。</small>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="save-kol-btn">保存</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="permission-group-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button" data-modal="permission-group-modal">&times;</span>
                    <h2 id="permission-group-modal-title">创建权限组</h2>
                    <form id="permission-group-form">
                        <input type="hidden" id="permission-group-id">
                        <div class="form-group">
                            <label for="permission-group-name">权限组名称:</label>
                            <input type="text" id="permission-group-name" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="course-package-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button" data-modal="course-package-modal">&times;</span>
                    <h2 id="course-package-modal-title">创建课程套餐</h2>
                    <form id="course-package-form">
                        <input type="hidden" id="course-package-id">
                        <div class="form-group">
                            <label for="package-group-id">所属权限组:</label>
                            <select id="package-group-id" required></select>
                        </div>
                        <div class="form-group">
                            <label for="package-duration-days">有效天数:</label>
                            <input type="number" id="package-duration-days" required min="1">
                        </div>
                        <div class="form-group">
                            <label for="package-price">价格:</label>
                            <input type="number" id="package-price" step="0.01" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="package-currency">货币:</label>
                            <input type="text" id="package-currency" value="USDT" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="course-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button" data-modal="course-modal">&times;</span>
                    <h2 id="course-modal-title">创建课程</h2>
                    <form id="course-form">
                        <input type="hidden" id="course-id">
                        <div class="form-group">
                            <label for="course-type">课程类型:</label>
                            <input type="text" id="course-type" value="article" required>
                        </div>
                        <div class="form-group">
                            <label for="course-name">课程名称:</label>
                            <input type="text" id="course-name" required>
                        </div>
                        <div class="form-group">
                            <label for="course-description">课程描述:</label>
                            <textarea id="course-description" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="course-content">课程内容 (Markdown):</label>
                            <textarea id="course-content" rows="8" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>分配到权限组:</label>
                            <div id="course-permission-groups-checkboxes"></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- <script src="env.js"></script> -->

    <script>
        const API_BASE_URL = 'https://api.devnet.ntxdao.com/api'; // Dev API URL

        const ITEMS_PER_PAGE = 10;
        let currentUserPage = 1;
        let currentReferralPage = 1;
        let currentCommissionPage = 1;
        let currentWithdrawalPage = 1;
        let currentAuctionPage = 1;

        let allUsers = [];
        let allExchanges = []; // Store all exchanges
        let allReferrals = [];
        let allCommissions = [];
        let allWithdrawalOrders = [];
        let allDaoAuctions = [];
        let allKols = []; // 新增：用于存储KOL列表

        // 放置在 let allKols = []; 之后
        let allPermissionGroups = [];
        let allCoursePackages = [];
        let allCourses = [];
        let allCourseOrders = [];
        // ====================================================================
        // Helper Functions
        // ====================================================================

        function getToken() {
            return localStorage.getItem('jwt_token');
        }

        function setToken(token) {
            localStorage.setItem('jwt_token', token);
        }

        function removeToken() {
            localStorage.removeItem('jwt_token');
        }

        async function fetchData(endpoint, method = 'GET', body = null) {
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json',
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const options = {
                method,
                headers,
            };
            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin${endpoint}`, options);
                
                if (response.status === 401) {
                    removeToken();
                    Swal.fire('认证过期', '请重新登录', 'error').then(() => {
                        showPage('login');
                    });
                    return null;
                }
                
                if (response.status === 403) {
                    Swal.fire('权限不足', '您没有执行此操作的权限', 'error');
                    return null;
                }
                
                const responseText = await response.text(); // Read the response body ONCE as text

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                    } catch (e) {
                        // If responseText is not valid JSON, use it as raw error message
                        throw new Error(`请求失败: ${response.statusText} - ${responseText || '未知错误'}`);
                    }
                    throw new Error(errorData.error || `请求失败: ${response.statusText}`);
                }
                
                // If responseText is empty, return null or an appropriate default
                if (!responseText) {
                    return null;
                }

                // Try to parse JSON for successful responses
                try {
                    return JSON.parse(responseText);
                } catch (e) {
                    console.error('Failed to parse JSON for successful response:', e);
                    // If a successful response is not JSON, return null or handle as plain text if expected
                    return null;
                }

            } catch (error) {
                console.error('Fetch error:', error);
                Swal.fire('错误', error.message, 'error');
                return null;
            }
        }

        // trigger fetch 
        async function triggerfetchData(endpoint, method = 'GET', body = null) {
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json',
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const options = {
                method,
                headers,
            };
            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE_URL}/system${endpoint}`, options);
                
                if (response.status === 401) {
                    removeToken();
                    Swal.fire('认证过期', '请重新登录', 'error').then(() => {
                        showPage('login');
                    });
                    return null;
                }
                
                if (response.status === 403) {
                    Swal.fire('权限不足', '您没有执行此操作的权限', 'error');
                    return null;
                }
                
                const responseText = await response.text(); // Read the response body ONCE as text

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                    } catch (e) {
                        // If responseText is not valid JSON, use it as raw error message
                        throw new Error(`请求失败: ${response.statusText} - ${responseText || '未知错误'}`);
                    }
                    throw new Error(errorData.error || `请求失败: ${response.statusText}`);
                }
                
                // If responseText is empty, return null or an appropriate default
                if (!responseText) {
                    return null;
                }

                // Try to parse JSON for successful responses
                try {
                    return JSON.parse(responseText);
                } catch (e) {
                    console.error('Failed to parse JSON for successful response:', e);
                    // If a successful response is not JSON, return null or handle as plain text if expected
                    return null;
                }

            } catch (error) {
                console.error('Fetch error:', error);
                Swal.fire('错误', error.message, 'error');
                return null;
            }
        }


        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function formatDateTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // ====================================================================
        // Authentication and Session Management
        // ====================================================================

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '登录失败');
                }

                const data = await response.json();
                if (data.token && data.isAdmin) {
                    setToken(data.token);
                    localStorage.setItem('admin_nickname', data.nickname || '管理员');
                    document.getElementById('admin-nickname').textContent = data.nickname || '管理员';
                    showPage('dashboard');
                    loadDashboardData(); 
                    showSection('dashboard');
                } else {
                    Swal.fire('登录失败', '您不是管理员或凭证错误。', 'error');
                }
            } catch (error) {
                Swal.fire('登录错误', error.message, 'error');
            }
        }

        // ====================================================================
        // Dashboard Functionality
        // ====================================================================

        async function loadDashboardData() {
            // Remove the date parameter as per user request
            const dashboardData = await fetchData('/dashboard');
            if (dashboardData) {
                // Update based on the new backend response structure
                document.getElementById('pending-withdrawals').textContent = dashboardData.pending_withdrawals || 0;
                document.getElementById('new-users-today').textContent = dashboardData.new_users_today || 0;
                document.getElementById('total-ntx-mined').textContent = dashboardData.totalMined ? dashboardData.totalMined.toFixed(2) : '0.00';
                document.getElementById('total-usdt-fees').textContent = dashboardData.totalCommission ? dashboardData.totalCommission.toFixed(2) : '0.00';
                document.getElementById('total-burned').textContent = dashboardData.totalBurned ? dashboardData.totalBurned.toFixed(2) : '0.00';
                document.getElementById('total-trading-volume-dashboard').textContent = dashboardData.totalTradingVolume ? dashboardData.totalTradingVolume.toFixed(2) : '0.00';
                document.getElementById('platform-users').textContent = dashboardData.platformUsers || 0;
            }
        }

        // ====================================================================
        // User Management Functionality
        // ====================================================================

        function renderUserList(page, query) {
            const tbody = document.getElementById('user-list-body');
            tbody.innerHTML = '';
            
            const filteredUsers = allUsers.filter(user => {
                const q = query.toLowerCase();
                return (user.id.toString().includes(q) ||
                        user.email.toLowerCase().includes(q) ||
                        user.nickname.toLowerCase().includes(q));
            });

            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedUsers = filteredUsers.slice(start, end);

            paginatedUsers.forEach(user => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.nickname}</td>
                    <td>${user.email}</td>
                    <td>${user.my_invite_code || '无'}</td> 
                    <td>${user.invited_by || '无'}</td>  
                    <td>${user.usdt_balance ? user.usdt_balance.toFixed(2) : '0.00'}</td>
                    <td>${user.ntx_balance ? user.ntx_balance.toFixed(2) : '0.00'}</td> 
                    <td>${user.is_active ? '活跃' : '已封禁'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openUserModal(${user.id})">编辑</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">删除</button>
                    </td>
                `;
            });

            document.getElementById('current-user-page-info').textContent = `第 ${page} 页 / 共 ${Math.ceil(filteredUsers.length / ITEMS_PER_PAGE)} 页`;
            document.getElementById('prev-user-page').disabled = page === 1;
            document.getElementById('next-user-page').disabled = end >= filteredUsers.length;
        }

        async function loadUsers(page = 1, query = '') {
            const users = await fetchData('/users');
            if (users) {
                allUsers = users;
                currentUserPage = page;
                renderUserList(currentUserPage, query);
            }
        }

        async function openUserModal(userId) {
            const user = await fetchData(`/users/${userId}/full_info`);
            if (user) {
                document.getElementById('user-id').value = user.id;
                document.getElementById('user-email').value = user.email;
                document.getElementById('user-nickname').value = user.nickname;
                document.getElementById('user-usdt-balance').value = user.usdtBalance || 0;
                document.getElementById('user-ntx-balance').value = user.ntxBalance || 0;
                document.getElementById('user-exp').value = user.exp || 0;
                document.getElementById('user-is-admin').checked = user.isAdmin || false;
                document.getElementById('user-is-active').checked = user.isActive || false;
                document.getElementById('user-is-broker').checked = user.isBroker || false;
                // Store myInviteCode from the full_info response in a hidden field
                document.getElementById('user-my-invite-code').value = user.myInviteCode || '';
                
                document.getElementById('user-modal').style.display = 'flex';
            }
        }

        document.getElementById('update-user-profile-btn').addEventListener('click', async () => {
            const userId = parseInt(document.getElementById('user-id').value);
            const payload = {
                user_id: userId,
                nickname: document.getElementById('user-nickname').value,
                email: document.getElementById('user-email').value,
                password: document.getElementById('user-password').value || null,
                myInviteCode: document.getElementById('user-my-invite-code').value, 
                exp: parseInt(document.getElementById('user-exp').value),
                usdtBalance: parseFloat(document.getElementById('user-usdt-balance').value),
                ntxBalance: parseFloat(document.getElementById('user-ntx-balance').value),
                isActive: document.getElementById('user-is-active').checked,
                isAdmin: document.getElementById('user-is-admin').checked,
                isBroker: document.getElementById('user-is-broker').checked,
            };
            
            const result = await fetchData('/user_profile/update', 'POST', payload);
            if (result) {
                Swal.fire('成功', '用户资料更新成功！', 'success');
                loadUsers(currentUserPage);
                document.getElementById('user-modal').style.display = 'none';
            }
        });

        document.getElementById('create-user-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const payload = {
                email: document.getElementById('new-user-email').value,
                nickname: document.getElementById('new-user-nickname').value,
                password: document.getElementById('new-user-password').value,
                invite_code: document.getElementById('new-user-invite-code').value || null,
                is_admin: document.getElementById('new-user-is-admin').checked
            };
            
            const result = await fetchData('/users', 'POST', payload);
            if (result) {
                Swal.fire('成功', '用户创建成功！', 'success');
                document.getElementById('create-user-modal').style.display = 'none';
                document.getElementById('create-user-form').reset();
                loadUsers();
            }
        });

        async function deleteUser(userId) {
            Swal.fire({
                title: '确认删除?',
                text: "您确定要删除此用户吗？此操作不可逆！",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '是的，删除它!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const response = await fetchData(`/users/${userId}`, 'DELETE');
                    if (response) {
                        Swal.fire('已删除!', '用户已被删除。', 'success');
                        loadUsers(currentUserPage);
                    }
                }
            });
        }

        document.getElementById('search-users-btn').addEventListener('click', () => {
            const query = document.getElementById('user-search-input').value;
            loadUsers(1, query);
        });

        document.getElementById('prev-user-page').addEventListener('click', () => {
            if (currentUserPage > 1) {
                currentUserPage--;
                renderUserList(currentUserPage, document.getElementById('user-search-input').value);
            }
        });

        document.getElementById('next-user-page').addEventListener('click', () => {
            const filteredUsers = allUsers.filter(user => {
                const q = document.getElementById('user-search-input').value.toLowerCase();
                return (user.id.toString().includes(q) ||
                        user.email.toLowerCase().includes(q) ||
                        user.nickname.toLowerCase().includes(q));
            });
            if ((currentUserPage * ITEMS_PER_PAGE) < filteredUsers.length) {
                currentUserPage++;
                renderUserList(currentUserPage, document.getElementById('user-search-input').value);
            }
        });

        // ====================================================================
        // Exchange Management Functionality
        // ====================================================================

        function renderExchangeList(exchanges) {
            const tbody = document.getElementById('exchange-list-body');
            tbody.innerHTML = '';
            exchanges.forEach(exchange => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${exchange.id}</td>
                    <td>${exchange.name}</td>
                    <td><img src="${exchange.logo_url}" alt="${exchange.name} Logo" style="width: 30px; height: 30px; border-radius: 50%;"></td>
                    <td>${exchange.mining_efficiency ? exchange.mining_efficiency.toFixed(2) : 'N/A'}</td>
                    <td><a href="${exchange.cex_url}" target="_blank">${exchange.cex_url || 'N/A'}</a></td>
                    <td>${formatDate(exchange.created_at)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openExchangeModal(${exchange.id}, '${exchange.name}', '${exchange.logo_url}', ${exchange.mining_efficiency}, '${escapeHtml(exchange.cex_url)}')">编辑</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteExchange(${exchange.id})">删除</button>
                    </td>
                `;
            });
        }

        async function loadExchanges() {
            const exchanges = await fetchData('/exchanges/all');
            if (exchanges) {
                allExchanges = exchanges; // Store all exchanges
                renderExchangeList(exchanges);
            }
        }

        function openExchangeModal(id = '', name = '', logoUrl = '', miningEfficiency = 1.0, cexUrl = '') {
            document.getElementById('exchange-id').value = id;
            document.getElementById('exchange-name').value = name;
            document.getElementById('exchange-logo-url').value = logoUrl;
            document.getElementById('exchange-mining-efficiency').value = miningEfficiency;
            document.getElementById('exchange-cex-url').value = cexUrl;

            document.getElementById('exchange-modal-title').textContent = id ? '编辑交易所' : '添加新交易所';
            document.getElementById('save-exchange-btn').textContent = id ? '更新' : '创建';
            document.getElementById('exchange-modal').style.display = 'flex';
        }

        document.getElementById('create-exchange-btn').addEventListener('click', () => openExchangeModal());

        document.getElementById('exchange-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const payload = {
                id: document.getElementById('exchange-id').value ? parseInt(document.getElementById('exchange-id').value) : undefined,
                name: document.getElementById('exchange-name').value,
                logoUrl: document.getElementById('exchange-logo-url').value,
                miningEfficiency: parseFloat(document.getElementById('exchange-mining-efficiency').value),
                cexUrl: document.getElementById('exchange-cex-url').value
            };
            
            const exchangeId = document.getElementById('exchange-id').value;
            const endpoint = exchangeId ? `/exchanges/${exchangeId}` : '/exchanges';
            const method = 'POST';

            const result = await fetchData(endpoint, method, payload);
            if (result) {
                Swal.fire('成功', `交易所${exchangeId ? '更新' : '创建'}成功！`, 'success');
                document.getElementById('exchange-modal').style.display = 'none';
                document.getElementById('exchange-form').reset();
                loadExchanges();
            }
        });

        async function deleteExchange(exchangeId) {
            Swal.fire({
                title: '确认删除?',
                text: "您确定要删除此交易所吗？此操作不可逆！",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '是的，删除它!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const response = await fetchData(`/exchanges/${exchangeId}`, 'DELETE');
                    if (response) {
                        Swal.fire('已删除!', '交易所已被删除。', 'success');
                        loadExchanges();
                    }
                }
            });
        }

        // ====================================================================
        // Trade Data Functionality (New Section)
        // ====================================================================

        // Populate User and Exchange dropdowns
        async function populateTradeDataDropdowns() {
            // Load users
            const users = await fetchData('/users');
            const userSelect = document.getElementById('trade-user-select');
            userSelect.innerHTML = '<option value="">-- 请选择用户 --</option>'; // Default option
            if (users) {
                allUsers = users; // Ensure allUsers is populated
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.id} - ${user.nickname} (${user.email})`;
                    userSelect.appendChild(option);
                });
            }

            // Load exchanges
            const exchanges = await fetchData('/exchanges/all');
            const exchangeSelect = document.getElementById('trade-exchange-select');
            exchangeSelect.innerHTML = '<option value="">-- 请选择交易所 --</option>'; // Default option
            if (exchanges) {
                allExchanges = exchanges; // Ensure allExchanges is populated
                exchanges.forEach(exchange => {
                    const option = document.createElement('option');
                    option.value = exchange.id;
                    option.textContent = `${exchange.id} - ${exchange.name}`;
                    exchangeSelect.appendChild(option);
                });
            }

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('trade-date').value = today;
        }

        // Handle Add Daily Trade Data Form Submission
        document.getElementById('add-trade-data-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const userId = parseInt(document.getElementById('trade-user-select').value);
            const exchangeId = parseInt(document.getElementById('trade-exchange-select').value);
            const tradeVolume = parseFloat(document.getElementById('trade-volume').value);
            const tradeFee = parseFloat(document.getElementById('trade-fee').value);
            const tradeDate = document.getElementById('trade-date').value;

            if (!userId || !exchangeId || isNaN(tradeVolume) || isNaN(tradeFee) || !tradeDate) {
                Swal.fire('错误', '请填写所有必填字段并确保输入有效数值。', 'warning');
                return;
            }
            if (tradeVolume < 0 || tradeFee < 0) {
                Swal.fire('错误', '交易量和手续费不能为负数。', 'warning');
                return;
            }

            const payload = {
                user_id: userId,
                exchange_id: exchangeId,
                trade_volume_usdt: tradeVolume,
                fee_usdt: tradeFee,
                trade_date: tradeDate
            };

            const result = await fetchData('/add_daily_trade_data', 'POST', payload);
            if (result) {
                Swal.fire('成功', '每日交易数据添加成功！', 'success');
                document.getElementById('add-trade-data-form').reset();
                // Re-set today's date after reset
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('trade-date').value = today;
            }
        });

        // ====================================================================
        // Article Management Functionality
        // ====================================================================

        function renderArticleList(articles) {
            const tbody = document.getElementById('article-list-body');
            tbody.innerHTML = '';
            articles.forEach(article => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${article.id}</td>
                    <td>${article.title}</td>
                    <td>${article.summary || '无摘要'}</td>
                    <td>${article.imageUrl ? `<img src="${article.imageUrl}" alt="文章图片" style="width: 50px; height: 30px; object-fit: cover;">` : '无'}</td>
                    <td>${article.isDisplayed ? '显示' : '隐藏'}</td>
                    <td>${formatDateTime(article.publishDate)}</td>
                    <td>${formatDateTime(article.modifyDate)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openArticleModal(${article.id})">编辑</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteArticle(${article.id})">删除</button>
                    </td>
                `;
            });
        }

        function escapeHtml(text) {
            // Ensure input is treated as a string
            if (typeof text !== 'string') {
                text = String(text);
            }
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        async function loadArticles() {
            const articles = await fetchData('/academy/articles/all');
            if (articles) {
                renderArticleList(articles);
            }
        }

        async function openArticleModal(articleId) {
            if (!articleId) {
                document.getElementById('article-id').value = '';
                document.getElementById('article-title').value = '';
                document.getElementById('article-summary').value = '';
                document.getElementById('article-image-url').value = '';
                document.getElementById('article-content').value = '';
                document.getElementById('article-is-displayed').checked = true;

                document.getElementById('article-modal-title').textContent = '发布新文章';
                document.getElementById('save-article-btn').textContent = '发布';
                document.getElementById('article-modal').style.display = 'flex';
                return;
            }

            const article = await fetchData(`/academy/articles/${articleId}`);
            if (article) {
                document.getElementById('article-id').value = article.id;
                document.getElementById('article-title').value = article.title;
                document.getElementById('article-summary').value = article.summary;
                document.getElementById('article-image-url').value = article.imageUrl || '';
                document.getElementById('article-content').value = article.content;
                document.getElementById('article-is-displayed').checked = article.isDisplayed;

                document.getElementById('article-modal-title').textContent = '编辑文章';
                document.getElementById('save-article-btn').textContent = '更新';
                document.getElementById('article-modal').style.display = 'flex';
            } else {
                Swal.fire('错误', '无法加载文章详情。', 'error');
            }
        }

        document.getElementById('publish-article-btn').addEventListener('click', () => openArticleModal());

        document.getElementById('article-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const payload = {
                title: document.getElementById('article-title').value,
                summary: document.getElementById('article-summary').value,
                imageUrl: document.getElementById('article-image-url').value || null,
                isDisplayed: document.getElementById('article-is-displayed').checked,
                content: document.getElementById('article-content').value
            };
            
            const articleId = document.getElementById('article-id').value;
            const endpoint = articleId ? `/academy/articles/${articleId}` : '/academy/articles';
            const method = 'POST';
            
            const result = await fetchData(endpoint, method, payload);
            if (result) {
                Swal.fire('成功', `文章${articleId ? '更新' : '发布'}成功！`, 'success');
                document.getElementById('article-modal').style.display = 'none';
                document.getElementById('article-form').reset();
                loadArticles();
            }
        });

        async function deleteArticle(articleId) {
            Swal.fire({
                title: '确认删除?',
                text: "您确定要删除此文章吗？此操作不可逆！",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '是的，删除它!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const response = await fetchData(`/academy/articles/${articleId}`, 'DELETE');
                    if (response) {
                        Swal.fire('已删除!', '文章已被删除。', 'success');
                        loadArticles();
                    }
                }
            });
        }

        // ====================================================================
        // Commission and Referral Functionality
        // ====================================================================
        
        function renderReferralRelationships(page) {
            const tbody = document.getElementById('referral-list-body');
            tbody.innerHTML = '';

            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedItems = allReferrals.slice(start, end);

            paginatedItems.forEach(rel => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${rel.inviterId}</td>
                    <td>${rel.inviterEmail || 'N/A'}</td>
                    <td>${rel.invitedUserId}</td>
                    <td>${rel.invitedUserNickname}</td>
                    <td>${rel.invitedUserEmail}</td>
                    <td>${formatDate(rel.invitedAt)}</td>
                `;
            });

            document.getElementById('current-referral-page-info').textContent = `第 ${page} 页 / 共 ${Math.ceil(allReferrals.length / ITEMS_PER_PAGE)} 页`;
            document.getElementById('prev-referral-page').disabled = page === 1;
            document.getElementById('next-referral-page').disabled = end >= allReferrals.length;
        }

        async function loadReferralRelationships(page = 1) {
            const relationships = await fetchData('/referrals/all');
            if (relationships) {
                allReferrals = relationships;
                currentReferralPage = page;
                renderReferralRelationships(currentReferralPage);
            }
        }

        document.getElementById('prev-referral-page').addEventListener('click', () => {
            if (currentReferralPage > 1) {
                currentReferralPage--;
                renderReferralRelationships(currentReferralPage);
            }
        });

        document.getElementById('next-referral-page').addEventListener('click', () => {
            if ((currentReferralPage * ITEMS_PER_PAGE) < allReferrals.length) {
                currentReferralPage++;
                renderReferralRelationships(currentReferralPage);
            }
        });

        function renderCommissionList(page) {
            const tbody = document.getElementById('commission-list-body');
            tbody.innerHTML = '';

            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedItems = allCommissions.slice(start, end);

            paginatedItems.forEach(commission => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${commission.invitedUserNickname}</td>
                    <td>${commission.currency}</td>
                    <td>${commission.amount ? commission.amount.toFixed(2) : '0.00'}</td>
                    <td>${formatDate(commission.date)}</td>
                `;
            });

            document.getElementById('current-commission-page-info').textContent = `第 ${page} 页 / 共 ${Math.ceil(allCommissions.length / ITEMS_PER_PAGE)} 页`;
            document.getElementById('prev-commission-page').disabled = page === 1;
            document.getElementById('next-commission-page').disabled = end >= allCommissions.length;
        }

        async function loadAllCommissions(page = 1) {
            const commissions = await fetchData('/commissions/all');
            if (commissions) {
                allCommissions = commissions;
                currentCommissionPage = page;
                renderCommissionList(currentCommissionPage);
            }
        }

         document.getElementById('prev-commission-page').addEventListener('click', () => {
            if (currentCommissionPage > 1) {
                currentCommissionPage--;
                renderCommissionList(currentCommissionPage);
            }
        });

        document.getElementById('next-commission-page').addEventListener('click', () => {
            if ((currentCommissionPage * ITEMS_PER_PAGE) < allCommissions.length) {
                currentCommissionPage++;
                renderCommissionList(currentCommissionPage);
            }
        });

        async function loadCommissionSummaryByInviter() {
            const summary = await fetchData('/commissions/summary_by_inviter');
            const tbody = document.getElementById('commission-summary-body');
            tbody.innerHTML = '';
            if (summary && summary.length > 0) {
                summary.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${item.inviterEmail || 'N/A'}</td>
                        <td>${item.totalUsdtCommission ? item.totalUsdtCommission.toFixed(2) : '0.00'}</td>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="2">无汇总佣金数据</td></tr>';
            }
        }

        // ====================================================================
        // Withdrawal Orders Management Functionality
        // ====================================================================

        function renderWithdrawalOrders(page) {
            const tbody = document.getElementById('withdrawal-list-body');
            tbody.innerHTML = '';

            const filterStatus = document.getElementById('withdrawal-status-filter').value;
            const filteredOrders = allWithdrawalOrders.filter(order => {
                return filterStatus === '' || order.status.toLowerCase() === filterStatus.toLowerCase();
            });

            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedOrders = filteredOrders.slice(start, end);

            paginatedOrders.forEach(order => {
                const row = tbody.insertRow();
                let actionsHtml = '';
                let statusDisplay = '';

                switch (order.status.toLowerCase()) {
                    case 'pending':
                        statusDisplay = '待处理';
                        actionsHtml = `
                            <button class="btn btn-success btn-sm" onclick="updateWithdrawalStatus(${order.id}, 'approved')">批准</button>
                            <button class="btn btn-danger btn-sm" onclick="updateWithdrawalStatus(${order.id}, 'rejected')">拒绝</button>
                        `;
                        break;
                    case 'approved':
                        statusDisplay = '已批准';
                        actionsHtml = `<span>已批准</span>`;
                        break;
                    case 'rejected':
                        statusDisplay = '已拒绝';
                        actionsHtml = `<span>已拒绝</span>`;
                        break;
                    case 'completed':
                        statusDisplay = '已完成';
                        actionsHtml = `<span>已完成</span>`;
                        break;
                    default:
                        statusDisplay = order.status;
                        actionsHtml = `<span>${order.status}</span>`;
                        break;
                }

                row.innerHTML = `
                    <td>${order.id}</td>
                    <td>${order.user_id}</td>
                    <td>${order.user_email || 'N/A'}</td>
                    <td>${order.amount ? order.amount.toFixed(2) : '0.00'}</td>
                    <td>${order.currency}</td>
                    <td>${order.to_address}</td>
                    <td>${formatDateTime(order.created_at)}</td>
                    <td>${order.processed_at ? formatDateTime(order.processed_at) : '待处理'}</td>
                    <td>${statusDisplay}</td>
                    <td>${actionsHtml}</td>
                `;
            });
            document.getElementById('current-withdrawal-page-info').textContent = `第 ${page} 页 / 共 ${Math.ceil(filteredOrders.length / ITEMS_PER_PAGE)} 页`;
            document.getElementById('prev-withdrawal-page').disabled = page === 1;
            document.getElementById('next-withdrawal-page').disabled = end >= filteredOrders.length;
        }

        async function loadWithdrawalOrders(page = 1) {
            const orders = await fetchData('/withdrawal_orders');
            if (orders) {
                allWithdrawalOrders = orders;
                currentWithdrawalPage = page;
                renderWithdrawalOrders(currentWithdrawalPage);
            }
        }

        async function updateWithdrawalStatus(orderId, status) {
            Swal.fire({
                title: '确认操作?',
                text: `您确定要将订单 #${orderId} 状态设置为 ${status === 'approved' ? '批准' : '拒绝'} 吗？`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '是的，执行操作!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const payload = {
                        order_id: parseInt(orderId),
                        status: status
                    };
                    
                    const response = await fetchData('/withdrawal_orders/update_status', 'POST', payload);
                    if (response) {
                        Swal.fire('成功', `订单 #${orderId} 状态已更新为 ${status === 'approved' ? '批准' : '拒绝'}。`, 'success');
                        loadWithdrawalOrders();
                    }
                }
            });
        }

        document.getElementById('filter-withdrawal-btn').addEventListener('click', () => {
            loadWithdrawalOrders(1);
        });

        document.getElementById('prev-withdrawal-page').addEventListener('click', () => {
            if (currentWithdrawalPage > 1) {
                currentWithdrawalPage--;
                renderWithdrawalOrders(currentWithdrawalPage);
            }
        });

        document.getElementById('next-withdrawal-page').addEventListener('click', () => {
            const filteredOrders = allWithdrawalOrders.filter(order => {
                const filterStatus = document.getElementById('withdrawal-status-filter').value;
                return filterStatus === '' || order.status.toLowerCase() === filterStatus.toLowerCase();
            });
            if ((currentWithdrawalPage * ITEMS_PER_PAGE) < filteredOrders.length) {
                currentWithdrawalPage++;
                renderWithdrawalOrders(currentWithdrawalPage);
            }
        });

        // ====================================================================
        // DAO Auction Management Functionality
        // ====================================================================
        function renderDaoAuctions(page) {
            const tbody = document.getElementById('dao-auction-list-body');
            tbody.innerHTML = '';

            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedAuctions = allDaoAuctions.slice(start, end);

            paginatedAuctions.forEach(auction => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${auction.id}</td>
                    <td>${auction.auction_round}</td>
                    <td>${auction.admin_bsc_address}</td>
                    <td>${formatDateTime(auction.start_time)}</td>
                    <td>${formatDateTime(auction.end_time)}</td>
                    <td>${auction.total_votes || 0}</td>
                    <td>${auction.total_ntx_participated ? auction.total_ntx_participated.toFixed(2) : '0.00'}</td>
                    <td>${auction.winner_user_id || '无'}</td>
                    <td>${auction.winner_ntx_amount ? auction.winner_ntx_amount.toFixed(2) : '0.00'}</td>
                    <td>${auction.winner_eth_address || '无'}</td>
                    <td>${auction.status}</td>
                `;
            });

            document.getElementById('current-auction-page-info').textContent = `第 ${page} 页 / 共 ${Math.ceil(allDaoAuctions.length / ITEMS_PER_PAGE)} 页`;
            document.getElementById('prev-auction-page').disabled = page === 1;
            document.getElementById('next-auction-page').disabled = end >= allDaoAuctions.length;
        }

        async function loadDaoAuctions(page = 1) {
            const auctions = await fetchData('/dao_auctions/history');
            if (auctions) {
                allDaoAuctions = auctions;
                currentAuctionPage = page;
                renderDaoAuctions(currentAuctionPage);
            }
        }

        document.getElementById('start-auction-btn').addEventListener('click', () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 10); // Current time + 10 minutes
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('auction-start-time').value = `${year}-${month}-${day}T${hours}:${minutes}`;

            document.getElementById('dao-auction-start-modal').style.display = 'flex';
        });

        document.getElementById('start-dao-auction-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const adminBscAddress = document.getElementById('admin-bsc-address').value;
            const startTimeLocal = document.getElementById('auction-start-time').value;
            const durationMinutes = parseInt(document.getElementById('auction-duration-minutes').value);

            const startTime = new Date(startTimeLocal).toISOString();
            
            const payload = {
                adminBscAddress: adminBscAddress,
                startTime: startTime,
                durationMinutes: durationMinutes
            };
            
            const result = await fetchData('/dao_auction/start', 'POST', payload);
            if (result) {
                Swal.fire('成功', '新一轮 DAO 拍卖已开始！', 'success');
                document.getElementById('dao-auction-start-modal').style.display = 'none';
                document.getElementById('start-dao-auction-form').reset();
                loadDaoAuctions();
            }
        });

        document.getElementById('end-auction-btn').addEventListener('click', async () => {
             Swal.fire({
                title: '确认结束当前拍卖?',
                text: "您确定要提前结束当前 DAO 拍卖吗？",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '是的，结束它!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const response = await fetchData('/dao_auction/end', 'POST');
                    if (response) {
                        Swal.fire('成功', '当前 DAO 拍卖已提前结束！', 'success');
                        loadDaoAuctions();
                    }
                }
            });
        });

        document.getElementById('prev-auction-page').addEventListener('click', () => {
            if (currentAuctionPage > 1) {
                currentAuctionPage--;
                renderDaoAuctions(currentAuctionPage);
            }
        });

        document.getElementById('next-auction-page').addEventListener('click', () => {
            if ((currentAuctionPage * ITEMS_PER_PAGE) < allDaoAuctions.length) {
                currentAuctionPage++;
                renderDaoAuctions(currentAuctionPage);
            }
        });

        // ====================================================================
        // User Exchange Bindings Functionality (NEW)
        // ====================================================================

        async function setupUserExchangeBindingsSection() {
            // 确保交易所数据已加载，以便填充下拉列表
            if (!allExchanges || allExchanges.length === 0) {
                await loadExchanges(); // 复用已有的加载交易所函数
            }
            populateBindingFilterDropdown();
            // 切换到此页面时，重置表格内容
            document.getElementById('binding-list-body').innerHTML = '<tr><td colspan="3" style="text-align:center;">请先选择一个交易所并点击查询。</td></tr>';
        }

        function populateBindingFilterDropdown() {
            const select = document.getElementById('binding-exchange-filter');
            select.innerHTML = '<option value="">-- 请选择 --</option>'; // 重置并添加默认选项

            if (allExchanges && allExchanges.length > 0) {
                allExchanges.forEach(exchange => {
                    const option = document.createElement('option');
                    option.value = exchange.id;
                    option.textContent = `${exchange.id} - ${exchange.name}`;
                    select.appendChild(option);
                });
            }
        }

        function renderBindingList(bindings) {
            const tbody = document.getElementById('binding-list-body');
            tbody.innerHTML = ''; // 清空旧数据

            if (!bindings || bindings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">此交易所无绑定用户或查询失败。</td></tr>';
                return;
            }

            bindings.forEach(binding => {
                const row = tbody.insertRow();
                // 根据后端返回的 UserExchangeBindingInfo 结构填充数据
                row.innerHTML = `
                    <td>${binding.userId}</td>
                    <td>${binding.email}</td>
                    <td>${binding.exchangeUid}</td>
                `;
            });
        }


        // ====================================================================
        // KOL Management Functionality (NEW)
        // ====================================================================

        function renderKolList(kols) {
            const tbody = document.getElementById('kol-list-body');
            tbody.innerHTML = '';
            if (!kols || kols.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">暂无KOL数据</td></tr>';
                return;
            }
            kols.forEach(kol => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${kol.user_id}</td>
                    <td>${kol.nickname || 'N/A'}</td>
                    <td>${kol.email || 'N/A'}</td>
                    <td>${kol.commission_rate ? kol.commission_rate.toFixed(2) : '0.00'}%</td>
                    <td><span class="btn btn-sm ${kol.is_active ? 'btn-success' : 'btn-secondary'}" style="cursor:default;">${kol.is_active ? '活跃' : '未激活'}</span></td>
                    <td>${formatDateTime(kol.created_at)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick='openKolModal(${kol.user_id}, ${kol.commission_rate}, ${kol.is_active})'>编辑</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteKol(${kol.user_id})">删除</button>
                    </td>
                `;
            });
        }

        async function loadKols() {
            const kols = await fetchData('/kols');
            if (kols) {
                allKols = kols;
                renderKolList(allKols);
            }
        }

        function openKolModal(userId = null, commissionRate = 85.0, isActive = true) {
            const form = document.getElementById('kol-form');
            form.reset();
            const userIdInput = document.getElementById('kol-user-id');
            const modalTitle = document.getElementById('kol-modal-title');

            if (userId) {
                // Edit Mode
                modalTitle.textContent = '编辑KOL信息';
                userIdInput.value = userId;
                userIdInput.disabled = true; // 不能在编辑时修改用户ID
                document.getElementById('kol-commission-rate').value = commissionRate;
                document.getElementById('kol-is-active').checked = isActive;
            } else {
                // Create Mode
                modalTitle.textContent = '添加新KOL';
                userIdInput.value = '';
                userIdInput.disabled = false;
            }
            
            document.getElementById('kol-modal').style.display = 'flex';
        }

        document.getElementById('kol-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const payload = {
                user_id: parseInt(document.getElementById('kol-user-id').value),
                commission_rate: parseFloat(document.getElementById('kol-commission-rate').value),
                is_active: document.getElementById('kol-is-active').checked,
            };

            const result = await fetchData('/kols', 'POST', payload);
            if (result) {
                Swal.fire('成功', 'KOL信息设置成功！', 'success');
                document.getElementById('kol-modal').style.display = 'none';
                loadKols(); // 重新加载列表以显示更新
            }
        });

        async function deleteKol(userId) {
            Swal.fire({
                title: '确认删除?',
                text: `您确定要永久移除用户ID ${userId} 的KOL身份吗？此操作不可逆！`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '是的，删除它!',
                cancelButtonText: '取消'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const response = await fetchData(`/kols/${userId}`, 'DELETE');
                    if (response) {
                        Swal.fire('已删除!', 'KOL身份已被成功移除。', 'success');
                        loadKols(); // 重新加载列表
                    }
                }
            });
        }


        // ====================================================================
        // Course & Payment Management Functionality (NEW)
        // ====================================================================

        // --- 订单管理 ---
        function renderCourseOrders(orders) {
            const tbody = document.getElementById('course-orders-list-body');
            tbody.innerHTML = '';
            if (!orders || orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">无订单数据</td></tr>';
                return;
            }
            orders.forEach(order => {
                const row = tbody.insertRow();
                let actionsHtml = '';
                if (order.status === 'pending') {
                    actionsHtml = `<button class="btn btn-success btn-sm" onclick="confirmCourseOrder(${order.id})">确认支付</button>`;
                }
                row.innerHTML = `
                    <td>${order.id}</td>
                    <td>${order.user_id}</td>
                    <td>${order.package_id}</td>
                    <td>${order.amount.toFixed(2)}</td>
                    <td>${order.paymentAmount.toFixed(5)}</td>
                    <td>${order.status}</td>
                    <td>${formatDateTime(order.created_at)}</td>
                    <td>${actionsHtml || '无操作'}</td>
                `;
            });
        }

        async function loadCourseOrders() {
            const status = document.getElementById('course-order-status-filter').value;
            const endpoint = status ? `/orders/all?status=${status}` : '/orders/all';
            const orders = await fetchData(endpoint);
            if (orders) {
                allCourseOrders = orders;
                renderCourseOrders(allCourseOrders);
            }
        }

        async function confirmCourseOrder(orderId) {
            Swal.fire({
                title: '确认订单支付?',
                text: `您确定要手动确认订单 #${orderId} 已成功支付吗？`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '是的，确认!',
                cancelButtonText: '取消'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const response = await fetchData(`/orders/${orderId}/confirm`, 'POST');
                    if (response) {
                        Swal.fire('成功!', '订单已确认，用户权限已授予。', 'success');
                        loadCourseOrders();
                    }
                }
            });
        }

        // --- 权限组管理 ---
        function renderPermissionGroups(groups) {
            const tbody = document.getElementById('permission-group-list-body');
            tbody.innerHTML = '';
            groups.forEach(group => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${group.id}</td>
                    <td>${escapeHtml(group.name)}</td>
                    <td>${formatDateTime(group.created_at)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openPermissionGroupModal(${group.id}, '${escapeHtml(group.name)}')">编辑</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePermissionGroup(${group.id})">删除</button>
                    </td>
                `;
            });
        }

        async function loadPermissionGroups() {
            const groups = await fetchData('/permission_groups/all');
            if (groups) {
                allPermissionGroups = groups;
                renderPermissionGroups(allPermissionGroups);
            }
        }

        function openPermissionGroupModal(id = null, name = '') {
            document.getElementById('permission-group-id').value = id || '';
            document.getElementById('permission-group-name').value = name;
            document.getElementById('permission-group-modal-title').textContent = id ? '编辑权限组' : '创建新权限组';
            document.getElementById('permission-group-modal').style.display = 'flex';
        }

        async function deletePermissionGroup(groupId) {
            Swal.fire({
                title: '确认删除?',
                text: `删除权限组会导致关联的套餐和课程权限失效！`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '确认删除'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const response = await fetchData(`/permission_groups/${groupId}`, 'DELETE');
                    if (response) {
                        Swal.fire('已删除', '权限组已成功删除。', 'success');
                        loadPermissionGroups();
                    }
                }
            });
        }

        // --- 课程套餐管理 ---
        function renderCoursePackages(packages) {
            const tbody = document.getElementById('course-package-list-body');
            tbody.innerHTML = '';
            packages.forEach(pkg => {
                const groupName = allPermissionGroups.find(g => g.id === pkg.group_id)?.name || '未知';
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${pkg.id}</td>
                    <td>${pkg.group_id} (${escapeHtml(groupName)})</td>
                    <td>${pkg.duration_days}</td>
                    <td>${pkg.price.toFixed(2)}</td>
                    <td>${pkg.currency}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openCoursePackageModal(${pkg.id})">编辑</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCoursePackage(${pkg.id})">删除</button>
                    </td>
                `;
            });
        }

        async function loadCoursePackages() {
            const packages = await fetchData('/course_packages/all');
            if (packages) {
                allCoursePackages = packages;
                renderCoursePackages(allCoursePackages);
            }
        }

        async function openCoursePackageModal(packageId = null) {
            const form = document.getElementById('course-package-form');
            form.reset();
            document.getElementById('course-package-id').value = packageId || '';
            
            // 填充权限组下拉菜单
            const groupSelect = document.getElementById('package-group-id');
            groupSelect.innerHTML = '';
            allPermissionGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = `${group.id} - ${group.name}`;
                groupSelect.appendChild(option);
            });

            if (packageId) {
                const pkg = allCoursePackages.find(p => p.id === packageId);
                if (pkg) {
                    document.getElementById('package-group-id').value = pkg.group_id;
                    document.getElementById('package-duration-days').value = pkg.duration_days;
                    document.getElementById('package-price').value = pkg.price;
                    document.getElementById('package-currency').value = pkg.currency;
                }
            }
            document.getElementById('course-package-modal-title').textContent = packageId ? '编辑课程套餐' : '创建新套餐';
            document.getElementById('course-package-modal').style.display = 'flex';
        }

        async function deleteCoursePackage(packageId) {
            Swal.fire({
                title: '确认删除?', text: "确认删除此套餐？", icon: 'warning', showCancelButton: true
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const response = await fetchData(`/course_packages/${packageId}`, 'DELETE');
                    if (response) {
                        Swal.fire('已删除', '套餐已成功删除。', 'success');
                        loadCoursePackages();
                    }
                }
            });
        }

        // --- 课程管理 ---
        function renderCourses(courses) {
            const tbody = document.getElementById('course-list-body');
            tbody.innerHTML = '';
            courses.forEach(course => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${course.id}</td>
                    <td>${escapeHtml(course.course_type)}</td>
                    <td>${escapeHtml(course.name)}</td>
                    <td>${escapeHtml(course.description)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openCourseModal(${course.id})">编辑</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCourse(${course.id})">删除</button>
                    </td>
                `;
            });
        }

        async function loadCourses() {
            const courses = await fetchData('/courses/all');
            if (courses) {
                allCourses = courses;
                renderCourses(allCourses);
            }
        }

        async function openCourseModal(courseId = null) {
            const form = document.getElementById('course-form');
            form.reset();
            document.getElementById('course-id').value = courseId || '';
            
            // 动态生成权限组复选框
            const checkboxesContainer = document.getElementById('course-permission-groups-checkboxes');
            checkboxesContainer.innerHTML = '';
            allPermissionGroups.forEach(group => {
                const checkboxHtml = `
                    <label style="margin-right: 15px;">
                        <input type="checkbox" name="course-permission-group" value="${group.id}">
                        ${escapeHtml(group.name)}
                    </label>`;
                checkboxesContainer.innerHTML += checkboxHtml;
            });

            if (courseId) {
                // --- ▼▼▼ 编辑模式下的修改从这里开始 ▼▼▼ ---
                document.getElementById('course-modal-title').textContent = '编辑课程';
                const course = allCourses.find(c => c.id === courseId);
                
                if(course) {
                    document.getElementById('course-type').value = course.course_type;
                    document.getElementById('course-name').value = course.name;
                    document.getElementById('course-description').value = course.description;
                    document.getElementById('course-content').value = course.content;
                    
                    // 1. 调用新API获取该课程已关联的权限组ID
                    const associatedGroupIds = await fetchData(`/courses/${courseId}/groups`);
                    
                    if (associatedGroupIds) {
                        // 2. 遍历所有复选框，如果其ID在返回的列表中，则勾选它
                        const groupCheckboxes = document.querySelectorAll('input[name="course-permission-group"]');
                        groupCheckboxes.forEach(checkbox => {
                            if (associatedGroupIds.includes(parseInt(checkbox.value))) {
                                checkbox.checked = true;
                            }
                        });
                    }
                }
                // --- ▲▲▲ 编辑模式下的修改在这里结束 ▲▲▲ ---
            } else {
                document.getElementById('course-modal-title').textContent = '创建新课程';
            }
            
            document.getElementById('course-modal').style.display = 'flex';
        }

        async function deleteCourse(courseId) {
            Swal.fire({
                title: '确认删除?', text: "确认删除此课程？", icon: 'warning', showCancelButton: true
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const response = await fetchData(`/courses/${courseId}`, 'DELETE');
                    if (response) {
                        Swal.fire('已删除', '课程已成功删除。', 'success');
                        loadCourses();
                    }
                }
            });
        }

        // ====================================================================
        // System Tools Functionality
        // ====================================================================

        document.getElementById('trigger-settlement-btn').addEventListener('click', async () => {
            const date = document.getElementById('settlement-date').value;
            if (!date) {
                Swal.fire('错误', '请选择要结算的日期！', 'warning');
                return;
            }
            
            const result = await triggerfetchData('/trigger_daily_settlement', 'POST', { date: date });
            if (result) {
                Swal.fire('成功', `${date} 的每日结算已成功触发！`, 'success');
            }
        });
        document.getElementById('force-ntx-control-btn').addEventListener('click', async () => {
            const date = document.getElementById('fntx-settlement-date').value;
            if (!date) {
                Swal.fire('错误', '请选择要结算的日期！', 'warning');
                return;
            }
            
            const result = await triggerfetchData('/force_ntx_control', 'POST', { date: date });
            if (result) {
                Swal.fire('成功', `${date} 已成功触发！`, 'success');
            }
        });
        //update-ntx-percentage-btn
        document.getElementById('update-ntx-percentage-btn').addEventListener('click', async () => {
            const percentage = parseFloat(document.getElementById('ntx-control-percentage').value);
            if (isNaN(percentage) || percentage < 0 || percentage > 100) {
                Swal.fire('错误', '请输入有效的百分比（0-100）！', 'warning');
                return;
            }
            
            const result = await fetchData('/ntx_control/update_percentage', 'POST', { admin_fee_percentage: percentage });
            if (result) {
                Swal.fire('成功', `NTX 控制百分比已更新为 ${percentage}%！`, 'success');
            }
        });

        // ====================================================================
        // Event Listeners and Initialization
        // ====================================================================

        function showPage(pageId) {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'none';
            
            if (pageId === 'login') {
                document.getElementById('login-page').style.display = 'flex';
            } else if (pageId === 'dashboard') {
                document.getElementById('main-dashboard').style.display = 'flex';
            }
        }
        
        function showSection(sectionId) {
            document.querySelectorAll('.content-area').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === sectionId) {
                    link.classList.add('active');
                }
            });
            
            const titleMap = {
                'dashboard': '仪表盘',
                'user-management': '用户管理',
                'exchange-management': '交易所管理',
                'trade-data': '交易数据',
                'article-management': '文章管理',
                'commission-referral': '佣金与推荐',
                'withdrawal-orders': '提现订单',
                'course-payment-management': '课程与支付管理',
                'dao-auction': 'DAO 拍卖',
                'kol-management': 'KOL管理', // 新增标题映射
                'system-tools': '系统工具'
            };
            document.getElementById('current-page-title').textContent = titleMap[sectionId] || '管理后台';
        }
        
        async function checkAuth() {
            const token = getToken();
            const nickname = localStorage.getItem('admin_nickname');

            if (token && nickname) {
                const dashboardData = await fetchData('/dashboard'); 
                if (dashboardData) {
                    document.getElementById('admin-nickname').textContent = nickname;
                    showPage('dashboard');
                    loadDashboardData();
                    showSection('dashboard');
                    return true;
                } else {
                    showPage('login');
                    return false;
                }
            } else {
                showPage('login');
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();

            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            document.getElementById('logout-button').addEventListener('click', () => {
                removeToken();
                localStorage.removeItem('admin_nickname');
                showPage('login');
                Swal.fire('已退出', '您已成功退出登录。', 'info');
            });
            
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection(this.dataset.section);
                    
                    switch(this.dataset.section) {
                        case 'dashboard':
                            loadDashboardData();
                            break;
                        case 'user-management':
                            loadUsers();
                            break;
                        case 'exchange-management':
                            loadExchanges();
                            break;
                        case 'trade-data':
                            populateTradeDataDropdowns();
                            break;
                        case 'article-management':
                            loadArticles();
                            break;
                        case 'commission-referral':
                            loadReferralRelationships();
                            loadAllCommissions();
                            loadCommissionSummaryByInviter();
                            break;
                        case 'withdrawal-orders':
                            loadWithdrawalOrders();
                            break;
                        case 'dao-auction':
                            loadDaoAuctions();
                            break;
                        case 'kol-management':
                            loadKols();
                            break;
                        case 'course-payment-management':
                            loadPermissionGroups();
                            loadCoursePackages();
                            loadCourses();
                            loadCourseOrders();
                            break;
                        case 'user-exchange-bindings':
                            setupUserExchangeBindingsSection();
                            break;
                        case 'system-tools':
                            document.getElementById('settlement-date').value = new Date().toISOString().split('T')[0];
                            document.getElementById('fntx-settlement-date').value = new Date().toISOString().split('T')[0];
                            document.getElementById('ntx-control-percentage').value= ' ';
                            break;
                    }
                });
            });
            
            document.querySelectorAll('.close-button').forEach(button => {
                button.addEventListener('click', function() {
                    document.getElementById(this.dataset.modal).style.display = 'none';
                });
            });
            
            window.addEventListener('click', (e) => {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });


            // 用户创建按钮
            document.getElementById('create-user-btn').addEventListener('click', () => {
                document.getElementById('create-user-modal').style.display = 'flex';
            });
            

                    // 新增：为“用户绑定查询”的查询按钮添加事件监听
        document.getElementById('search-bindings-btn').addEventListener('click', async () => {
            const exchangeId = document.getElementById('binding-exchange-filter').value;
            const tbody = document.getElementById('binding-list-body');

            if (!exchangeId) {
                Swal.fire('提示', '请先选择一个交易所', 'info');
                return;
            }
            
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">正在查询...</td></tr>';

            // 调用新的API接口
            const bindings = await triggerfetchData(`/exchanges/${exchangeId}/users`);
            renderBindingList(bindings); // 使用新函数渲染结果
        });

        // 新增：KOL创建按钮
        document.getElementById('create-kol-btn').addEventListener('click', () => {
            openKolModal();
        });
        
        // 放置在 document.getElementById('create-kol-btn').addEventListener('click', ...); 之后

// --- 课程与支付管理事件监听 ---
document.getElementById('filter-course-orders-btn').addEventListener('click', loadCourseOrders);
document.getElementById('create-permission-group-btn').addEventListener('click', () => openPermissionGroupModal());
document.getElementById('create-course-package-btn').addEventListener('click', () => openCoursePackageModal());
document.getElementById('create-course-btn').addEventListener('click', () => openCourseModal());

document.getElementById('permission-group-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('permission-group-id').value;
    const payload = { name: document.getElementById('permission-group-name').value };
    const endpoint = id ? `/permission_groups/${id}` : '/permission_groups';
    const method = id ? 'PUT' : 'POST';
    
    const result = await fetchData(endpoint, method, payload);
    if (result) {
        Swal.fire('成功', '权限组已保存', 'success');
        document.getElementById('permission-group-modal').style.display = 'none';
        loadPermissionGroups();
    }
});

document.getElementById('course-package-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('course-package-id').value;
    const payload = {
        group_id: parseInt(document.getElementById('package-group-id').value),
        duration_days: parseInt(document.getElementById('package-duration-days').value),
        price: parseFloat(document.getElementById('package-price').value),
        currency: document.getElementById('package-currency').value
    };
    const endpoint = id ? `/course_packages/${id}` : '/course_packages';
    const method = id ? 'PUT' : 'POST';

    const result = await fetchData(endpoint, method, payload);
    if (result) {
        Swal.fire('成功', '课程套餐已保存', 'success');
        document.getElementById('course-package-modal').style.display = 'none';
        loadCoursePackages();
    }
});

document.getElementById('course-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('course-id').value;
    const payload = {
        course_type: document.getElementById('course-type').value,
        name: document.getElementById('course-name').value,
        description: document.getElementById('course-description').value,
        content: document.getElementById('course-content').value
    };
    const endpoint = id ? `/courses/${id}` : '/courses';
    const method = id ? 'PUT' : 'POST';
    
    const result = await fetchData(endpoint, method, payload);
    if (result && result.id) { // 创建成功后，处理权限组关联
        const courseId = id || result.id;
        const groupCheckboxes = document.querySelectorAll('input[name="course-permission-group"]:checked');
        for (const checkbox of groupCheckboxes) {
            await fetchData(`/courses/${courseId}/assign_group`, 'POST', { group_id: parseInt(checkbox.value) });
        }
        Swal.fire('成功', '课程已保存', 'success');
        document.getElementById('course-modal').style.display = 'none';
        loadCourses();
    } else if (result) { // 更新成功
        Swal.fire('成功', '课程已更新', 'success');
        document.getElementById('course-modal').style.display = 'none';
        loadCourses();
    }
});


     });
    </script>
</body>
</html>